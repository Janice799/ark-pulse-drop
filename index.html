<!--
  Project: ARK [Pulse Drop] v5.0 "NEON ASCEND ULTRA" | Created by Solo Alchemist | ARK
  Phase 1: Neon Grid + Dual Orbit Ring + Glassmorphism UI + Enhanced Judgment FX
  Monetization: Reward Ads + Skin Shop + Coin System + Leaderboard
-->
<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="description" content="ARK Pulse Drop ‚Äî Premium rhythm timing game" />
    <meta name="theme-color" content="#07080c" />
    <title>ARK ‚Äî Pulse Drop</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap"
        rel="stylesheet" />
    <style>
        :root {
            --bg: #05060a;
            --panel: rgba(255, 255, 255, .04);
            --text: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .50);
            --good: #62ffb3;
            --perfect: #7fe0ff;
            --ok: #ffd36a;
            --bad: #ff5d7a;
            --accent: #8c7bff
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            background: #05060a;
            color: var(--text);
            font-family: 'Outfit', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: radial-gradient(ellipse 140% 80% at 50% 0%, rgba(140, 123, 255, .05), transparent), #05060a
        }

        * {
            user-select: none;
            -webkit-user-select: none
        }

        .wrap {
            width: min(520px, 100vw);
            height: min(920px, 100vh);
            position: relative;
            padding: 12px
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 32px;
            background: linear-gradient(180deg, rgba(5, 6, 10, 1) 0%, rgba(8, 10, 18, 1) 100%);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, .04), 0 0 60px rgba(140, 123, 255, .06), 0 30px 80px rgba(0, 0, 0, .55);
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent
        }
    </style>
</head>

<body>
    <div class="wrap"><canvas id="c"></canvas></div>

    <!-- Mobile Name Input (hidden overlay for virtual keyboard) -->
    <input id="mobileNameInput" type="text" maxlength="12"
        style="position:fixed;top:-9999px;left:0;width:1px;height:1px;opacity:0;font-size:16px;z-index:-1;"
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />

    <!-- v5.0 Premium Coin Shop Modal -->
    <style>
        @keyframes coinShopSlideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }

            100% {
                background-position: 200% center;
            }
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 8px var(--glow-color);
            }

            50% {
                box-shadow: 0 0 20px var(--glow-color), 0 0 40px var(--glow-color);
            }
        }

        #coinShopModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(5, 6, 15, .95) 0%, rgba(10, 8, 25, .98) 100%);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 99999;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #coinShopModal .cs-inner {
            max-width: 380px;
            margin: 0 auto;
            padding: 32px 16px 40px;
            animation: coinShopSlideUp .4s cubic-bezier(.22, 1, .36, 1) forwards;
        }

        #coinShopModal .cs-title {
            text-align: center;
            color: #00ffcc;
            font-family: 'Outfit', sans-serif;
            font-size: 26px;
            font-weight: 800;
            margin: 0 0 4px;
            text-shadow: 0 0 30px rgba(0, 255, 204, .4);
        }

        #coinShopModal .cs-sub {
            text-align: center;
            color: rgba(255, 255, 255, .35);
            font-family: 'Outfit', sans-serif;
            font-size: 12px;
            margin: 0 0 6px;
        }

        #coinShopModal .cs-balance {
            text-align: center;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #ffd36a;
            margin: 0 0 20px;
            text-shadow: 0 0 12px rgba(255, 211, 106, .3);
        }

        .coin-pack-card {
            position: relative;
            border-radius: 16px;
            padding: 16px 16px 12px;
            margin-bottom: 14px;
            transition: transform .15s, box-shadow .15s;
        }

        .coin-pack-card:active {
            transform: scale(.97);
        }

        .coin-pack-card.tier-starter {
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .1);
        }

        .coin-pack-card.tier-plus {
            background: rgba(0, 255, 204, .03);
            border: 1px solid rgba(0, 255, 204, .2);
            --glow-color: rgba(0, 255, 204, .15);
        }

        .coin-pack-card.tier-pro {
            background: rgba(255, 211, 106, .03);
            border: 1px solid rgba(255, 211, 106, .25);
            --glow-color: rgba(255, 211, 106, .2);
            animation: pulseGlow 3s ease-in-out infinite;
        }

        .coin-pack-card.tier-ultra {
            background: linear-gradient(135deg, rgba(140, 123, 255, .06), rgba(255, 211, 106, .04));
            border: 1px solid rgba(140, 123, 255, .3);
            --glow-color: rgba(140, 123, 255, .25);
            animation: pulseGlow 2s ease-in-out infinite;
        }

        .coin-pack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .coin-pack-label {
            font-family: 'Outfit', sans-serif;
            font-size: 17px;
            font-weight: 700;
            color: white;
        }

        .coin-pack-price {
            font-family: 'Outfit', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: #ffd36a;
            text-shadow: 0 0 12px rgba(255, 211, 106, .3);
        }

        .badge-bonus {
            display: inline-block;
            font-family: 'Outfit', sans-serif;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .badge-bonus.cyan {
            background: rgba(0, 255, 204, .15);
            color: #00ffcc;
        }

        .badge-bonus.gold {
            background: rgba(255, 211, 106, .15);
            color: #ffd36a;
        }

        .badge-popular {
            position: absolute;
            top: -6px;
            right: 16px;
            background: linear-gradient(135deg, #8c7bff, #b06aff);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 9px;
            font-weight: 800;
            padding: 3px 10px;
            border-radius: 10px;
            letter-spacing: .5px;
            box-shadow: 0 2px 12px rgba(140, 123, 255, .4);
        }

        .badge-bestvalue {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #ffd36a, #ffaa00, #ffd36a);
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
            color: #1a1200;
            font-family: 'Outfit', sans-serif;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 14px;
            border-radius: 12px;
            letter-spacing: .8px;
            box-shadow: 0 2px 16px rgba(255, 211, 106, .5);
        }

        .cs-close-btn {
            display: block;
            width: 100%;
            margin: 16px 0 0;
            padding: 14px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 14px;
            color: rgba(255, 255, 255, .45);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            backdrop-filter: blur(4px);
        }

        .cs-close-btn:hover {
            background: rgba(255, 255, 255, .08);
            color: rgba(255, 255, 255, .7);
        }
    </style>

    <div id="coinShopModal">
        <div class="cs-inner">
            <h2 class="cs-title">üíé COIN SHOP</h2>
            <p class="cs-sub">Power up with premium coins</p>
            <div class="cs-balance" id="coinShopBalance">Your Balance: ‚óÜ 0</div>
            <div id="coinPacksContainer"></div>
            <button id="coinShopClose" class="cs-close-btn">‚Üê Back to Shop</button>
        </div>
    </div>
    <script src="js/audio.js"></script>
    <script src="js/ads.js"></script>
    <script src="js/shop.js"></script>
    <script src="js/leaderboard.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/paypal-shop.js"></script>
    <script>
        (() => {
            'use strict';
            const C = document.getElementById('c'), X = C.getContext('2d');
            let W, H;
            function resize() { const d = Math.min(devicePixelRatio || 1, 2), r = C.getBoundingClientRect(); W = r.width; H = r.height; C.width = W * d; C.height = H * d; X.setTransform(d, 0, 0, d, 0, 0) }
            addEventListener('resize', resize); resize();

            // ‚îÄ‚îÄ‚îÄ Firebase + Global Leaderboard Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (async () => {
                try {
                    if (window.FirebaseService) {
                        await FirebaseService.init();
                        await Leaderboard.initGlobal();
                        console.log('[ARK] üåê Firebase & Global Leaderboard active');
                    }
                } catch (e) { console.warn('[ARK] Firebase boot skipped:', e); }
            })();

            // ‚îÄ‚îÄ‚îÄ States ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const S = { MENU: 0, PLAY: 1, OVER: 2, SHOP: 3, BOARD: 4, NAME: 5, DIFF: 6 };
            let state = S.MENU, t = 0, score = 0, combo = 0, maxCombo = 0, level = 1, lives = 5, bpm = 66;
            let hi = +(localStorage.getItem('arkPD_hi') || 0);
            let fb = '', fbC = '', fbT = 0, spT = '', spTm = 0, cShk = 0;
            let particles = [], ripples = [], bgP = [];
            let menuT = 0, goT = 0, earnedCoins = 0;
            let shopScroll = 0, shopTarget = 0, boardData = [];
            let nameInput = '', nameInputActive = false, nameCursor = 0;

            // ‚îÄ‚îÄ‚îÄ v4.0 NEON ASCEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let gridOffset = 0, orbitAngle = 0;
            let vignetteT = 0, screenFlashT = 0, screenFlashC = '#7fe0ff';

            // ‚îÄ‚îÄ‚îÄ v4.0 Phase 2: Difficulty / Fever / Accuracy ‚îÄ‚îÄ
            let difficulty = 1; // 0=EASY, 1=NORMAL, 2=HARD
            const DIFF_CFG = [
                { name: 'EASY', emoji: 'üåø', color: '#62ffb3', lives: 7, bpmBase: 56, thrMult: 1.4, scoreMult: 0.8 },
                { name: 'NORMAL', emoji: '‚ö°', color: '#7fe0ff', lives: 5, bpmBase: 66, thrMult: 1.0, scoreMult: 1.0 },
                { name: 'HARD', emoji: 'üî•', color: '#ff5d7a', lives: 3, bpmBase: 80, thrMult: 0.7, scoreMult: 1.5 }
            ];
            let feverMode = false, feverT = 0;
            let accP = 0, accG = 0, accO = 0, accM = 0; // accuracy counters
            let rollScore = 0; // rolling score animation for game over

            // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function rr(x, y, w, h, r) { X.beginPath(); X.moveTo(x + r, y); X.lineTo(x + w - r, y); X.quadraticCurveTo(x + w, y, x + w, y + r); X.lineTo(x + w, y + h - r); X.quadraticCurveTo(x + w, y + h, x + w - r, y + h); X.lineTo(x + r, y + h); X.quadraticCurveTo(x, y + h, x, y + h - r); X.lineTo(x, y + r); X.quadraticCurveTo(x, y, x + r, y); X.closePath() }
            function pill(x, y, w, h, f = 'rgba(255,255,255,.06)') { X.save(); rr(x, y, w, h, h / 2); X.fillStyle = f; X.fill(); X.strokeStyle = 'rgba(255,255,255,.08)'; X.lineWidth = 1; X.stroke(); X.restore() }
            function eOB(t) { const c = 1.7; return 1 + (c + 1) * Math.pow(t - 1, 3) + c * Math.pow(t - 1, 2) }
            function hexRGB(hex) { return [parseInt(hex.slice(1, 3), 16), parseInt(hex.slice(3, 5), 16), parseInt(hex.slice(5, 7), 16)] }
            function spd() { return (1 + (level - 1) * .12) * (difficulty === 2 ? 1.15 : difficulty === 0 ? 0.85 : 1) }
            function thr() { const b = Math.max(.035, .08 - (level - 1) * .004) * DIFF_CFG[difficulty].thrMult; return { p: b, g: b * 3, o: b * 6 } }
            function scoreMult() { return DIFF_CFG[difficulty].scoreMult * (feverMode ? 1.5 : 1) }
            function pv(time) { return (1 - Math.cos(time * Math.PI * 2 * spd())) * .5 }

            // Rainbow color
            function rainbowColor(t) {
                const r = Math.sin(t) * .5 + .5, g = Math.sin(t + 2.094) * .5 + .5, b = Math.sin(t + 4.189) * .5 + .5;
                return `rgb(${r * 255 | 0},${g * 255 | 0},${b * 255 | 0})`;
            }

            // ‚îÄ‚îÄ‚îÄ Particles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function burst(x, y, color, n = 15) { for (let i = 0; i < n; i++) { const a = Math.PI * 2 * i / n + Math.random() * .3, s = 1.5 + Math.random() * 3.5; particles.push({ x, y, vx: Math.cos(a) * s, vy: Math.sin(a) * s, life: 1, decay: .012 + Math.random() * .015, size: 2 + Math.random() * 3, color }) } }
            function ripple(x, y, c) { ripples.push({ x, y, r: 10, mx: 120 + Math.random() * 60, life: 1, c }) }
            function initBg() { bgP = []; for (let i = 0; i < 35; i++)bgP.push({ x: Math.random() * W, y: Math.random() * H, sz: .5 + Math.random() * 1.5, sp: .1 + Math.random() * .3, op: .12 + Math.random() * .18, ph: Math.random() * Math.PI * 2 }) }

            // ‚îÄ‚îÄ‚îÄ v4.0 Glassmorphism Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function glassPanel(x, y, w, h, r = 20, tint = [140, 123, 255], op = 0.07) {
                X.save();
                rr(x, y, w, h, r); X.fillStyle = `rgba(${tint[0]},${tint[1]},${tint[2]},${op})`; X.fill();
                const gd = X.createLinearGradient(x, y, x, y + h * 0.5);
                gd.addColorStop(0, 'rgba(255,255,255,.06)'); gd.addColorStop(1, 'rgba(255,255,255,0)');
                rr(x, y, w, h, r); X.fillStyle = gd; X.fill();
                rr(x, y, w, h, r); X.strokeStyle = 'rgba(255,255,255,.08)'; X.lineWidth = 1; X.stroke();
                X.restore();
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Neon Grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawNeonGrid(intensity = 0.3, beat = 0) {
                const cx = W / 2, hy = H * 0.36;
                const sk = SkinShop.getCurrentSkin();
                const col = sk.rainbow ? '#8c7bff' : sk.ring;
                const [r, g, b] = hexRGB(col);
                gridOffset = (gridOffset + 0.003 * (state === S.PLAY ? spd() : 0.7)) % 1;
                for (let i = 0; i <= 16; i++) {
                    const raw = (i / 16 + gridOffset) % 1;
                    const y = hy + (H - hy) * Math.pow(raw, 1.8);
                    const a = Math.pow(raw, 0.5) * intensity * (0.6 + beat * 0.4);
                    if (a < 0.005) continue;
                    X.beginPath(); X.moveTo(0, y); X.lineTo(W, y);
                    X.strokeStyle = `rgba(${r},${g},${b},${Math.min(a, 0.28)})`;
                    X.lineWidth = 1 + beat * 0.5; X.stroke();
                }
                for (let i = -10; i <= 10; i++) {
                    const xB = cx + i * (W * 0.06), xT = cx + i * 3;
                    const a = (1 - Math.abs(i) / 10) * intensity * 0.4;
                    if (a < 0.005) continue;
                    X.beginPath(); X.moveTo(xB, H); X.lineTo(xT, hy);
                    X.strokeStyle = `rgba(${r},${g},${b},${Math.min(a, 0.16)})`;
                    X.lineWidth = 1; X.stroke();
                }
                const hg = X.createLinearGradient(0, hy - 20, 0, hy + 20);
                hg.addColorStop(0, `rgba(${r},${g},${b},0)`);
                hg.addColorStop(0.5, `rgba(${r},${g},${b},${intensity * 0.12 + beat * 0.06})`);
                hg.addColorStop(1, `rgba(${r},${g},${b},0)`);
                X.fillStyle = hg; X.fillRect(0, hy - 20, W, 40);
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Orbit Ring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawOrbitRing(cx, cy, baseR, dt) {
                const sk = SkinShop.getCurrentSkin();
                const rc = sk.rainbow ? rainbowColor(t * 3) : sk.ring;
                const [r, g, b] = hexRGB(rc);
                const oR = baseR * 0.55;
                orbitAngle += dt * (1.2 + Math.min(combo, 30) * 0.04);
                X.beginPath(); X.arc(cx, cy, oR, 0, Math.PI * 2);
                X.strokeStyle = `rgba(${r},${g},${b},0.04)`; X.lineWidth = 1;
                X.setLineDash([3, 8]); X.stroke(); X.setLineDash([]);
                for (let i = 0; i < 3; i++) {
                    const ang = orbitAngle + (Math.PI * 2 / 3) * i;
                    for (let s = 0; s < 8; s++) {
                        const a1 = ang - (Math.PI * 0.3 * s / 8);
                        const a2 = ang - (Math.PI * 0.3 * (s + 1) / 8);
                        X.beginPath(); X.arc(cx, cy, oR, a2, a1);
                        X.strokeStyle = `rgba(${r},${g},${b},${(1 - s / 8) * 0.2})`;
                        X.lineWidth = 2.5 - s * 0.25; X.stroke();
                    }
                    const ox = cx + Math.cos(ang) * oR, oy = cy + Math.sin(ang) * oR;
                    X.beginPath(); X.arc(ox, oy, 2.5, 0, Math.PI * 2);
                    X.fillStyle = rc; X.shadowBlur = 10; X.shadowColor = rc;
                    X.fill(); X.shadowBlur = 0;
                }
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Post-FX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawPostFX(dt) {
                if (vignetteT > 0) {
                    vignetteT -= dt * 2.5;
                    const grad = X.createRadialGradient(W / 2, H / 2, Math.min(W, H) * 0.25, W / 2, H / 2, Math.max(W, H) * 0.7);
                    grad.addColorStop(0, 'rgba(0,0,0,0)');
                    grad.addColorStop(1, `rgba(255,50,80,${vignetteT * 0.22})`);
                    X.fillStyle = grad; X.fillRect(0, 0, W, H);
                }
                if (screenFlashT > 0) {
                    screenFlashT -= dt * 5;
                    const [fr, fg, fb] = hexRGB(screenFlashC);
                    X.fillStyle = `rgba(${fr},${fg},${fb},${screenFlashT * 0.06})`;
                    X.fillRect(0, 0, W, H);
                }
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Draw: Difficulty Select ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawDifficulty(dt) {
                clearBtns(); menuT += dt;
                drawNeonGrid(0.2, Math.sin(menuT * 2) * 0.5 + 0.5);
                drawBg();
                const cx = W / 2;

                glassPanel(cx - W * 0.4, H * 0.12, W * 0.8, 80, 20, [140, 123, 255], 0.05);
                X.font = '800 22px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.9)';
                X.shadowBlur = 20; X.shadowColor = 'rgba(140,123,255,.4)';
                X.fillText('SELECT DIFFICULTY', cx, H * 0.12 + 35);
                X.shadowBlur = 0;
                X.font = '400 11px Outfit'; X.fillStyle = 'rgba(255,255,255,.4)';
                X.fillText('Choose your challenge level', cx, H * 0.12 + 58);

                const cardW = W * 0.75, cardH = 110, startY = H * 0.28, gap = 16;
                DIFF_CFG.forEach((d, i) => {
                    const y = startY + i * (cardH + gap);
                    const isSelected = difficulty === i;
                    glassPanel((W - cardW) / 2, y, cardW, cardH, 18, hexRGB(d.color), isSelected ? 0.12 : 0.05);

                    // Emoji + Name
                    X.font = '700 28px Outfit'; X.textAlign = 'center'; X.fillStyle = d.color;
                    X.fillText(d.emoji, cx, y + 32);
                    X.font = '700 18px Outfit'; X.fillText(d.name, cx, y + 56);

                    // Stats
                    X.font = '400 11px Outfit'; X.fillStyle = 'rgba(255,255,255,.5)';
                    const info = `Lives: ${d.lives}  |  Speed: ${d.bpmBase} BPM  |  Score: √ó${d.scoreMult}`;
                    X.fillText(info, cx, y + 78);

                    // Select indicator
                    if (isSelected) {
                        X.font = '600 10px Outfit'; X.fillStyle = d.color;
                        X.fillText('‚ñ∂ SELECTED', cx, y + 96);
                    }
                    addBtn('diff_' + i, (W - cardW) / 2, y, cardW, cardH);
                });

                // Start button
                const bY = startY + 3 * (cardH + gap) + 8;
                glassPanel((W - cardW) / 2, bY, cardW, 50, 14, hexRGB(DIFF_CFG[difficulty].color), 0.1);
                X.font = '700 16px Outfit'; X.textAlign = 'center'; X.fillStyle = DIFF_CFG[difficulty].color;
                X.shadowBlur = 10; X.shadowColor = DIFF_CFG[difficulty].color;
                X.fillText('‚ñ∂  START GAME', cx, bY + 32); X.shadowBlur = 0;
                addBtn('start_game', (W - cardW) / 2, bY, cardW, 50);

                // Back
                glassPanel(24, H - 64, W - 48, 42, 12);
                X.font = '600 13px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.6)'; X.fillText('‚Üê BACK', cx, H - 37);
                addBtn('back', 24, H - 64, W - 48, 42);
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Draw: Fever Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawFeverOverlay(dt) {
                if (!feverMode) return;
                feverT += dt;
                // Rainbow edge glow
                const gL = X.createLinearGradient(0, 0, 0, H);
                const gR = X.createLinearGradient(W, 0, W, H);
                for (let i = 0; i <= 4; i++) {
                    const c = rainbowColor(feverT * 3 + i * 1.5);
                    gL.addColorStop(i / 4, c); gR.addColorStop(i / 4, c);
                }
                X.globalAlpha = 0.06 + Math.sin(feverT * 6) * 0.03;
                X.fillStyle = gL; X.fillRect(0, 0, 8, H);
                X.fillStyle = gR; X.fillRect(W - 8, 0, 8, H);
                // Top/bottom chromatic bars
                X.fillStyle = gL; X.fillRect(0, 0, W, 4);
                X.fillRect(0, H - 4, W, 4);
                X.globalAlpha = 1;
                // FEVER badge
                X.save(); X.translate(W / 2, 85);
                const fs = 1 + Math.sin(feverT * 8) * 0.05;
                X.scale(fs, fs);
                X.font = '800 12px Outfit'; X.textAlign = 'center';
                X.fillStyle = rainbowColor(feverT * 4);
                X.shadowBlur = 15; X.shadowColor = X.fillStyle;
                X.fillText('üî• FEVER √ó1.5', 0, 0);
                X.shadowBlur = 0; X.restore();
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Phase 3: Achievements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const ACHIEVEMENTS = [
                { id: 'first_perfect', name: 'First Light', desc: 'Get your first PERFECT', icon: '‚ú®', color: '#7fe0ff' },
                { id: 'combo_10', name: 'Chain Reaction', desc: 'Reach 10x Combo', icon: '‚ö°', color: '#ffd36a' },
                { id: 'combo_25', name: 'Unstoppable', desc: 'Reach 25x Combo', icon: 'üí•', color: '#ff5d7a' },
                { id: 'score_200', name: 'Rising Star', desc: 'Score 200 points', icon: '‚≠ê', color: '#62ffb3' },
                { id: 'score_500', name: 'Neon Master', desc: 'Score 500 points', icon: 'üíé', color: '#8c7bff' },
                { id: 'fever_first', name: 'Fever Time!', desc: 'Activate Fever Mode', icon: 'üåà', color: '#ff9d5c' },
                { id: 'hard_200', name: 'Iron Will', desc: 'Score 200+ on HARD', icon: 'üèÜ', color: '#ff5d7a' },
                { id: 'flawless', name: 'Flawless', desc: 'Finish with 0 MISS', icon: 'üí´', color: '#7fe0ff' }
            ];
            let unlockedAch = new Set(JSON.parse(localStorage.getItem('arkPD_ach') || '[]'));
            let achQueue = []; // popup queue
            let achPopT = 0, achPopCurrent = null;

            function saveAch() { localStorage.setItem('arkPD_ach', JSON.stringify([...unlockedAch])) }
            function unlockAch(id) {
                if (unlockedAch.has(id)) return;
                unlockedAch.add(id); saveAch();
                const a = ACHIEVEMENTS.find(a => a.id === id);
                if (a) achQueue.push(a);
            }
            function checkAchievements(isGameOver = false) {
                if (accP >= 1) unlockAch('first_perfect');
                if (maxCombo >= 10) unlockAch('combo_10');
                if (maxCombo >= 25) unlockAch('combo_25');
                if (score >= 200) unlockAch('score_200');
                if (score >= 500) unlockAch('score_500');
                if (feverMode) unlockAch('fever_first');
                if (difficulty === 2 && score >= 200) unlockAch('hard_200');
                if (isGameOver && accM === 0 && (accP + accG + accO) > 0) unlockAch('flawless');
            }

            // Achievement popup drawing
            function drawAchPopup(dt) {
                // Process queue
                if (!achPopCurrent && achQueue.length > 0) {
                    achPopCurrent = achQueue.shift();
                    achPopT = 3.0; // 3 seconds display
                }
                if (!achPopCurrent) return;
                achPopT -= dt;
                if (achPopT <= 0) { achPopCurrent = null; return; }

                const a = achPopCurrent;
                const fadeIn = Math.min(1, (3.0 - achPopT) * 4);
                const fadeOut = Math.min(1, achPopT * 3);
                const alpha = Math.min(fadeIn, fadeOut);
                const slideY = (1 - fadeIn) * -30;

                X.save();
                X.globalAlpha = alpha;
                const pW = W * 0.7, pH = 52, pX = (W - pW) / 2, pY = H * 0.06 + slideY;
                glassPanel(pX, pY, pW, pH, 14, hexRGB(a.color), 0.12);

                // Icon
                X.font = '700 20px Outfit'; X.textAlign = 'left'; X.fillStyle = a.color;
                X.fillText(a.icon, pX + 14, pY + 30);
                // Title
                X.font = '700 12px Outfit'; X.fillStyle = a.color;
                X.shadowBlur = 8; X.shadowColor = a.color;
                X.fillText('ACHIEVEMENT UNLOCKED', pX + 44, pY + 18);
                X.shadowBlur = 0;
                // Name
                X.font = '600 13px Outfit'; X.fillStyle = 'rgba(255,255,255,.9)';
                X.fillText(a.name + ' ‚Äî ' + a.desc, pX + 44, pY + 38);

                X.restore();
            }

            // ‚îÄ‚îÄ‚îÄ v4.0 Phase 3: Wave Announcement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let waveAnnT = 0, waveAnnLevel = 0;
            function triggerWave(lv) { waveAnnT = 2.5; waveAnnLevel = lv; }
            function drawWaveAnn(dt) {
                if (waveAnnT <= 0) return;
                waveAnnT -= dt;
                const cx = W / 2, cy = H * 0.32;
                const fadeIn = Math.min(1, (2.5 - waveAnnT) * 5);
                const fadeOut = Math.min(1, waveAnnT * 2);
                const alpha = Math.min(fadeIn, fadeOut);
                const sc = 0.5 + fadeIn * 0.5;

                X.save();
                X.globalAlpha = alpha;
                X.translate(cx, cy); X.scale(sc, sc);

                // Ring burst
                const ringR = 40 + (1 - fadeOut) * 60;
                X.beginPath(); X.arc(0, 0, ringR, 0, Math.PI * 2);
                X.strokeStyle = `rgba(140,123,255,${alpha * 0.4})`;
                X.lineWidth = 3; X.shadowBlur = 20; X.shadowColor = 'rgba(140,123,255,.5)';
                X.stroke(); X.shadowBlur = 0;

                // WAVE text
                X.font = '300 14px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(140,123,255,.7)';
                X.fillText('W A V E', 0, -14);
                X.font = '800 48px Outfit'; X.fillStyle = 'rgba(255,255,255,.95)';
                X.shadowBlur = 30; X.shadowColor = 'rgba(140,123,255,.6)';
                X.fillText(waveAnnLevel.toString(), 0, 32);
                X.shadowBlur = 0;

                X.restore();
            }

            // ‚îÄ‚îÄ‚îÄ Hit Zones (buttons) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let buttons = [];
            function addBtn(id, x, y, w, h) { buttons.push({ id, x, y, w, h }) }
            function hitBtn(px, py) { return buttons.find(b => px >= b.x && px <= b.x + b.w && py >= b.y && py <= b.y + b.h) }
            function clearBtns() { buttons = [] }

            // ‚îÄ‚îÄ‚îÄ Draw: Background particles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawBg() { bgP.forEach(p => { p.y -= p.sp; p.ph += .01; if (p.y < -10) { p.y = H + 10; p.x = Math.random() * W } const ox = Math.sin(p.ph) * 15; X.beginPath(); X.arc(p.x + ox, p.y, p.sz, 0, Math.PI * 2); X.fillStyle = `rgba(255,255,255,${p.op * (.5 + .5 * Math.sin(p.ph))})`; X.fill() }) }

            // ‚îÄ‚îÄ‚îÄ Draw: Particles & Ripples ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawFX() {
                ripples.forEach((rp, i) => { rp.r += (rp.mx - rp.r) * .06; rp.life -= .025; if (rp.life <= 0) { ripples.splice(i, 1); return } const [r, g, b] = hexRGB(rp.c); X.beginPath(); X.arc(rp.x, rp.y, rp.r, 0, Math.PI * 2); X.strokeStyle = `rgba(${r},${g},${b},${rp.life * .35})`; X.lineWidth = 2 * rp.life; X.stroke() });
                particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.vx *= .97; p.vy *= .97; p.life -= p.decay; if (p.life <= 0) { particles.splice(i, 1); return } const [r, g, b] = hexRGB(p.color); X.beginPath(); X.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2); X.fillStyle = `rgba(${r},${g},${b},${p.life * .7})`; X.fill() });
            }

            // ‚îÄ‚îÄ‚îÄ Draw: Menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawMenu(dt) {
                clearBtns(); menuT += dt;
                drawNeonGrid(0.22, Math.sin(menuT * 2) * 0.5 + 0.5);
                drawBg();
                const cx = W / 2, cy = H * .30;

                // v4.0 Glassmorphism title card
                glassPanel(cx - W * 0.4, cy - 68, W * 0.8, 135, 24, [140, 123, 255], 0.05);

                // Title
                X.save(); X.translate(cx, cy); const sc = 1 + Math.sin(menuT * 1.5) * .02; X.scale(sc, sc);
                X.font = '800 13px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(140,123,255,.6)'; X.fillText('A R K', 0, -38);
                X.font = '700 38px Outfit'; X.fillStyle = 'rgba(255,255,255,.95)'; X.shadowBlur = 40; X.shadowColor = 'rgba(140,123,255,.5)'; X.fillText('Pulse Drop', 0, 2); X.shadowBlur = 0;
                X.font = '400 11px Outfit'; X.fillStyle = 'rgba(140,123,255,.45)'; X.fillText('v5.0 ‚Äî NEON ASCEND ULTRA', 0, 26);
                X.restore();

                // Ring anim with orbit
                const rr2 = 50 + Math.sin(menuT * 2) * 15;
                X.beginPath(); X.arc(cx, cy + 80, rr2, 0, Math.PI * 2);
                X.strokeStyle = `rgba(127,224,255,${.4 + Math.sin(menuT * 2) * .2})`; X.lineWidth = 3; X.shadowBlur = 25; X.shadowColor = 'rgba(127,224,255,.4)'; X.stroke(); X.shadowBlur = 0;
                X.beginPath(); X.arc(cx, cy + 80, 4, 0, Math.PI * 2); X.fillStyle = 'rgba(127,224,255,.8)'; X.fill();
                drawOrbitRing(cx, cy + 80, rr2 * 2.2, dt);

                // TAP TO START
                const a = .4 + Math.sin(menuT * 3) * .3;
                X.font = '500 15px Outfit'; X.textAlign = 'center'; X.fillStyle = `rgba(255,255,255,${a})`; X.fillText('TAP TO START', cx, cy + 160);
                if (hi > 0) { X.font = '400 12px Outfit'; X.fillStyle = 'rgba(255,255,255,.3)'; X.fillText(`BEST  ${hi}`, cx, cy + 185) }

                // Coins display
                X.font = '600 13px Outfit'; X.fillStyle = '#ffd36a'; X.textAlign = 'right'; X.fillText('‚óÜ ' + SkinShop.getCoins(), W - 28, 38);

                // v4.0 Glassmorphism bottom buttons
                const btnW = W * .38, btnH = 48, btnY = H * .78, gap = 14;
                const bx1 = (W - btnW * 2 - gap) / 2, bx2 = bx1 + btnW + gap;

                glassPanel(bx1, btnY, btnW, btnH, 14, [140, 123, 255], 0.08);
                X.font = '600 14px Outfit'; X.textAlign = 'center'; X.fillStyle = '#8c7bff'; X.fillText('üíé SHOP', bx1 + btnW / 2, btnY + 30);
                addBtn('shop', bx1, btnY, btnW, btnH);

                glassPanel(bx2, btnY, btnW, btnH, 14, [98, 255, 179], 0.06);
                X.font = '600 14px Outfit'; X.textAlign = 'center'; X.fillStyle = '#62ffb3'; X.fillText('üèÜ RANK', bx2 + btnW / 2, btnY + 30);
                addBtn('board', bx2, btnY, btnW, btnH);

                // Equipped skin
                const sk = SkinShop.getCurrentSkin();
                X.font = '400 11px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.22)';
                X.fillText(`Skin: ${sk.name}`, cx, H - 32);
                X.font = '300 10px Outfit'; X.fillStyle = 'rgba(140,123,255,.2)'; X.fillText('v5.0 NEON ASCEND ULTRA ‚Äî ARK', cx, H - 14);
            }

            // ‚îÄ‚îÄ‚îÄ Draw: Game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawGame(dt) {
                const cx = W / 2, cy = H * .44, sk = SkinShop.getCurrentSkin();
                const baseR = Math.min(W, H) * .20, n = pv(t), r = baseR * (.35 + .65 * n);
                const ringColor = sk.rainbow ? rainbowColor(t * 3) : sk.ring;
                const beatSync = 1 - n;

                // v4.0 Neon grid synced to beat (boosted in fever)
                drawNeonGrid(0.18 + combo * 0.004 + (feverMode ? 0.15 : 0), beatSync);
                drawBg();

                // v4.0 Orbit ring (dual ring system)
                drawOrbitRing(cx, cy, baseR, dt);

                // Fever check
                if (combo >= 15 && !feverMode) { feverMode = true; feverT = 0; }
                if (feverMode && combo < 15) feverMode = false;

                // Target ring
                X.beginPath(); X.arc(cx, cy, baseR * .35, 0, Math.PI * 2);
                X.strokeStyle = `rgba(255,255,255,${.06 + (n < .1 ? (.1 - n) * 1.5 : 0)})`; X.lineWidth = 2; X.setLineDash([4, 8]); X.stroke(); X.setLineDash([]);

                // Enhanced glow
                const gg = X.createRadialGradient(cx, cy, r - 10, cx, cy, r + 50);
                const [gr, ggr, gb] = hexRGB(sk.rainbow ? '#ffffff' : sk.ring);
                gg.addColorStop(0, `rgba(${gr},${ggr},${gb},${.10 + n * .08})`); gg.addColorStop(1, `rgba(${gr},${ggr},${gb},0)`);
                X.fillStyle = gg; X.beginPath(); X.arc(cx, cy, r + 50, 0, Math.PI * 2); X.fill();

                // Main ring (enhanced glow)
                X.beginPath(); X.arc(cx, cy, r, 0, Math.PI * 2);
                X.strokeStyle = ringColor; X.lineWidth = n < .08 ? 10 : 6; X.shadowBlur = 30 + (1 - n) * 20; X.shadowColor = ringColor; X.stroke(); X.shadowBlur = 0;

                // Center dot
                X.beginPath(); X.arc(cx, cy, 3 + (1 - n) * 3, 0, Math.PI * 2); X.fillStyle = ringColor; X.shadowBlur = 12; X.shadowColor = ringColor; X.fill(); X.shadowBlur = 0;

                drawFX();

                // HUD
                X.font = '700 26px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.9)'; X.fillText(score.toString(), cx, 46);
                X.font = '400 9px Outfit'; X.fillStyle = 'rgba(255,255,255,.3)'; X.fillText('SCORE', cx, 21);

                // Level pill
                pill(18, 18, 56, 24); X.font = '600 11px Outfit'; X.textAlign = 'center'; X.fillStyle = ringColor; X.fillText('LV ' + level, 46, 34);

                // Lives
                pill(W - 74, 18, 56, 24); let hStr = ''; for (let i = 0; i < 5; i++)hStr += i < lives ? '‚ô•' : '‚ô°';
                X.font = '500 11px Outfit'; X.fillStyle = lives <= 2 ? '#ff5d7a' : 'rgba(255,255,255,.6)'; X.fillText(hStr, W - 46, 34);

                // Coins
                X.font = '600 11px Outfit'; X.fillStyle = '#ffd36a'; X.textAlign = 'right'; X.fillText('‚óÜ' + SkinShop.getCoins(), W - 20, 62);

                // Combo (enhanced glow for high combos)
                if (combo > 1) {
                    const shX = cShk > 0 ? (Math.random() - .5) * cShk * 4 : 0; cShk *= .9;
                    X.font = '700 15px Outfit'; X.textAlign = 'center';
                    X.fillStyle = combo >= 10 ? '#ffd36a' : combo >= 5 ? '#62ffb3' : 'rgba(255,255,255,.6)';
                    if (combo >= 10) { X.shadowBlur = 8; X.shadowColor = '#ffd36a'; }
                    X.fillText(`${combo}x COMBO`, cx + shX, 65); X.shadowBlur = 0;
                }

                // v5.0 Enhanced Judgment Feedback (MOVED TO BOTTOM ‚Äî Reddit fix)
                if (fbT > 0) {
                    fbT -= dt; const pr = Math.max(0, fbT / 1.2);
                    const rawP = Math.min(1, (1.2 - fbT) * 5);
                    const sc2 = rawP < 0.5 ? eOB(rawP * 2) * 1.2 : 1 + 0.2 * Math.pow(1 - (rawP - 0.5) * 2, 2);
                    const yo = (1 - pr) * -18;

                    // Multi-ring flash effect (stays on center ring)
                    if (fbT > 0.4) {
                        const flashA = (fbT - 0.4) / 0.8;
                        const [fr, fg, fbb] = hexRGB(fbC);
                        for (let ri = 0; ri < 3; ri++) {
                            X.beginPath(); X.arc(cx, cy, baseR * .35 + ri * 8, 0, Math.PI * 2);
                            X.strokeStyle = `rgba(${fr},${fg},${fbb},${flashA * 0.5 * (1 - ri * 0.3)})`;
                            X.lineWidth = 3 - ri; X.shadowBlur = 15 + flashA * 15; X.shadowColor = fbC;
                            X.stroke();
                        }
                        X.shadowBlur = 0;
                    }

                    // v5.0 Edge flash effect (side bars glow with judgment color)
                    if (fbT > 0.3) {
                        const edgeA = (fbT - 0.3) / 0.9 * 0.4;
                        const [er, eg, eb] = hexRGB(fbC);
                        const edgeGradL = X.createLinearGradient(0, 0, 30, 0);
                        edgeGradL.addColorStop(0, `rgba(${er},${eg},${eb},${edgeA})`); edgeGradL.addColorStop(1, 'rgba(0,0,0,0)');
                        X.fillStyle = edgeGradL; X.fillRect(0, 0, 30, H);
                        const edgeGradR = X.createLinearGradient(W, 0, W - 30, 0);
                        edgeGradR.addColorStop(0, `rgba(${er},${eg},${eb},${edgeA})`); edgeGradR.addColorStop(1, 'rgba(0,0,0,0)');
                        X.fillStyle = edgeGradR; X.fillRect(W - 30, 0, 30, H);
                    }

                    // v5.0 Judgment text ‚Äî BOTTOM position (near timing bar)
                    X.save();
                    const shakeX = fb === 'MISS' ? (Math.random() - 0.5) * 8 * pr : 0;
                    const judgY = H - 105 + yo;
                    X.translate(cx + shakeX, judgY); X.scale(sc2, sc2);
                    X.font = '800 32px Outfit'; X.textAlign = 'center'; X.fillStyle = fbC;
                    X.globalAlpha = pr; X.shadowBlur = 30; X.shadowColor = fbC; X.fillText(fb, 0, 0);
                    X.shadowBlur = 50; X.globalAlpha = pr * 0.3; X.fillText(fb, 0, 0);
                    X.shadowBlur = 0; X.restore(); X.globalAlpha = 1;

                    // Score popup also at bottom
                    if (spTm > 0) { spTm -= dt; X.font = '600 15px Outfit'; X.fillStyle = `rgba(255,255,255,${spTm / .8 * .7})`; X.textAlign = 'center'; X.fillText(spT, cx, H - 75 + (1 - spTm / .8) * -12) }
                }

                // Post-FX
                drawPostFX(dt);
                drawFeverOverlay(dt);
                drawWaveAnn(dt);
                drawAchPopup(dt);

                // Difficulty badge
                const dc = DIFF_CFG[difficulty];
                pill(W / 2 - 28, H - 38, 56, 18, `rgba(${hexRGB(dc.color).join(',')},0.1)`);
                X.font = '600 9px Outfit'; X.textAlign = 'center'; X.fillStyle = dc.color;
                X.fillText(dc.emoji + ' ' + dc.name, W / 2, H - 25);

                // Timing bar
                const bW = W * .55, bH = 5, bX = (W - bW) / 2, bY = H - 58;
                rr(bX, bY, bW, bH, 3); X.fillStyle = 'rgba(255,255,255,.05)'; X.fill();
                const dPos = bX + n * bW; X.beginPath(); X.arc(dPos, bY + bH / 2, 4, 0, Math.PI * 2);
                const th2 = thr(); X.fillStyle = n < th2.p ? '#7fe0ff' : n < th2.g ? '#62ffb3' : n < th2.o ? '#ffd36a' : 'rgba(255,255,255,.3)';
                X.shadowBlur = 6; X.shadowColor = X.fillStyle; X.fill(); X.shadowBlur = 0;

                X.font = '300 10px Outfit'; X.textAlign = 'left'; X.fillStyle = 'rgba(255,255,255,.18)'; X.fillText(`BEST ${hi}`, 24, H - 22);
                X.textAlign = 'right'; X.fillText(`MAX √ó${maxCombo}`, W - 24, H - 22);
            }

            // ‚îÄ‚îÄ‚îÄ Draw: Game Over (v5.0 ULTRA ‚Äî Mockup Match) ‚îÄ‚îÄ
            function drawGameOver(dt) {
                clearBtns(); goT += dt; const cx = W / 2;
                X.fillStyle = `rgba(5,6,10,${Math.min(.8, goT * .8)})`; X.fillRect(0, 0, W, H);
                const fade = Math.min(1, goT * 2);

                const cW = W * .92, cH = 560, cX = (W - cW) / 2, cY = H * .03;
                X.save(); X.globalAlpha = fade;
                glassPanel(cX, cY, cW, cH, 28, [127, 224, 255], 0.10);

                // Difficulty badge ‚Äî bigger, brighter pill
                const dc = DIFF_CFG[difficulty];
                const dbW = 100, dbH = 30, dbX = cx - dbW / 2;
                rr(dbX, cY + 10, dbW, dbH, 15);
                X.fillStyle = `rgba(${hexRGB(dc.color).join(',')},0.25)`; X.fill();
                X.strokeStyle = `rgba(${hexRGB(dc.color).join(',')},0.5)`; X.lineWidth = 2; X.stroke();
                X.font = '800 14px Outfit'; X.textAlign = 'center'; X.fillStyle = dc.color;
                X.shadowBlur = 8; X.shadowColor = dc.color;
                X.fillText(dc.emoji + ' ' + dc.name, cx, cY + 30); X.shadowBlur = 0;

                // GAME OVER ‚Äî massive with light ray glow
                X.font = '900 38px Outfit'; X.fillStyle = 'rgba(255,255,255,.97)';
                X.shadowBlur = 30; X.shadowColor = 'rgba(127,224,255,.5)';
                X.fillText('GAME OVER', cx, cY + 68);
                // Second glow pass
                X.shadowBlur = 60; X.globalAlpha = .3;
                X.fillText('GAME OVER', cx, cY + 68);
                X.shadowBlur = 0; X.globalAlpha = 1;

                // "FINAL SCORE" label
                X.font = '500 12px Outfit'; X.fillStyle = 'rgba(255,255,255,.4)'; X.fillText('FINAL SCORE', cx, cY + 88);

                // MASSIVE score ‚Äî quadruple glow (mockup: huge radiating number)
                rollScore += (score - rollScore) * 0.08;
                if (Math.abs(score - rollScore) < 1) rollScore = score;
                const scoreStr = Math.round(rollScore).toLocaleString();
                X.font = '800 72px Outfit'; X.fillStyle = '#7fe0ff';
                // Glow layer 1
                X.shadowBlur = 40; X.shadowColor = 'rgba(127,224,255,.7)';
                X.fillText(scoreStr, cx, cY + 154);
                // Glow layer 2
                X.shadowBlur = 80; X.globalAlpha = .3;
                X.fillText(scoreStr, cx, cY + 154);
                // Glow layer 3 ‚Äî wide diffuse
                X.shadowBlur = 120; X.globalAlpha = .15;
                X.fillText(scoreStr, cx, cY + 154);
                X.shadowBlur = 0; X.globalAlpha = 1;

                // NEW BEST ‚Äî big golden with star pulse
                let nextY = cY + 174;
                if (score >= hi && score > 0) {
                    const goldPulse = 22 + Math.sin(goT * 5) * 16;
                    X.font = '800 20px Outfit'; X.fillStyle = '#ffd36a';
                    X.shadowBlur = goldPulse; X.shadowColor = 'rgba(255,211,106,.8)';
                    X.fillText('‚≠ê NEW BEST! ‚≠ê', cx, nextY);
                    X.shadowBlur = 0; nextY += 28;
                } else { nextY += 4; }

                // Coins earned ‚Äî bigger with shine
                X.font = '800 18px Outfit'; X.fillStyle = '#ffd36a';
                X.shadowBlur = 16; X.shadowColor = 'rgba(255,211,106,.5)';
                X.fillText(`‚óÜ +${earnedCoins} coins`, cx, nextY);
                X.shadowBlur = 0; nextY += 32;

                // ACCURACY label + percentage ‚Äî bigger
                const total = accP + accG + accO + accM;
                const accPct = total > 0 ? ((accP * 100 + accG * 75 + accO * 30) / (total * 100) * 100).toFixed(1) : '0.0';
                X.font = '800 15px Outfit'; X.fillStyle = 'rgba(255,255,255,.9)';
                X.fillText(`ACCURACY  ${accPct}%`, cx, nextY); nextY += 16;

                // Rainbow gradient accuracy bar ‚Äî THICKER, with rounded ends
                const barW = cW - 36, barH = 16, barX = cX + 18;
                rr(barX, nextY, barW, barH, 8); X.fillStyle = 'rgba(255,255,255,.06)'; X.fill();
                if (total > 0) {
                    const pW = (accP / total) * barW, gW = (accG / total) * barW;
                    const oW = (accO / total) * barW, mW = (accM / total) * barW;
                    let bx = barX;
                    if (pW > 0) {
                        rr(bx, nextY, Math.max(pW, 8), barH, 8);
                        X.fillStyle = '#7fe0ff'; X.shadowBlur = 12; X.shadowColor = '#7fe0ff';
                        X.fill(); X.shadowBlur = 0; bx += pW;
                    }
                    if (gW > 0) { X.fillStyle = '#62ffb3'; X.fillRect(bx, nextY, gW, barH); bx += gW; }
                    if (oW > 0) { X.fillStyle = '#ffd36a'; X.fillRect(bx, nextY, oW, barH); bx += oW; }
                    if (mW > 0) {
                        rr(bx, nextY, Math.max(mW, 8), barH, 0);
                        X.fillStyle = '#ff5d7a'; X.fill();
                    }
                    // Percentage marker
                    const markerX = barX + barW * parseFloat(accPct) / 100;
                    X.font = '700 10px Outfit'; X.fillStyle = 'rgba(255,255,255,.6)'; X.textAlign = 'center';
                    X.fillText(`${accPct}%`, Math.min(markerX, barX + barW - 16), nextY - 4);
                }
                nextY += barH + 18;

                // Judgment counts ‚Äî OVERSIZED colored pills with emoji icons
                const jData = [
                    ['PERFECT', accP, '#7fe0ff', 'rgba(127,224,255,.15)', 'üëë'],
                    ['GOOD', accG, '#62ffb3', 'rgba(98,255,179,.12)', 'üëç'],
                    ['OK', accO, '#ffd36a', 'rgba(255,211,106,.12)', 'üëå'],
                    ['MISS', accM, '#ff5d7a', 'rgba(255,93,122,.12)', '‚ùå']
                ];
                const pillW = (cW - 44) / 4 - 6, pillH = 70;
                jData.forEach(([label, count, color, bg, emoji], i) => {
                    const jx = cX + 12 + i * (pillW + 8);
                    // Pill background with colored border
                    rr(jx, nextY, pillW, pillH, 14);
                    X.fillStyle = bg; X.fill();
                    X.strokeStyle = color.replace(')', ',.3)').replace('rgb', 'rgba'); X.lineWidth = 1.5; X.stroke();
                    // Big Emoji
                    X.font = '700 20px Outfit'; X.textAlign = 'center';
                    X.fillText(emoji, jx + pillW / 2, nextY + 24);
                    // Label
                    X.font = '600 9px Outfit'; X.fillStyle = 'rgba(255,255,255,.5)';
                    X.fillText(label, jx + pillW / 2, nextY + 38);
                    // Big Count with glow
                    X.font = '800 22px Outfit'; X.fillStyle = color;
                    if (i === 0 && accP > 0) { X.shadowBlur = 10; X.shadowColor = color; }
                    X.fillText(count.toString(), jx + pillW / 2, nextY + 60); X.shadowBlur = 0;
                });
                nextY += pillH + 16;

                // Stats row ‚Äî bigger glassmorphism cards with glow borders
                const statW = (cW - 52) / 3 - 6, statH = 54;
                [['LEVEL ‚ö°', level], ['MAX COMBO üî•', '√ó' + maxCombo], ['BEST üèÜ', hi]].forEach(([l, v], i) => {
                    const sx = cX + 14 + i * (statW + 10);
                    rr(sx, nextY, statW, statH, 12);
                    X.fillStyle = 'rgba(255,255,255,.05)'; X.fill();
                    X.strokeStyle = 'rgba(255,255,255,.12)'; X.lineWidth = 1.5; X.stroke();
                    X.font = '500 9px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.4)';
                    X.fillText(l, sx + statW / 2, nextY + 18);
                    X.font = '800 20px Outfit'; X.fillStyle = 'rgba(255,255,255,.9)';
                    X.fillText(v.toString(), sx + statW / 2, nextY + 42);
                });
                nextY += statH + 12;

                // Achievement badges
                const sessionAch = ACHIEVEMENTS.filter(a => unlockedAch.has(a.id));
                if (sessionAch.length > 0) {
                    X.font = '600 11px Outfit'; X.fillStyle = 'rgba(255,255,255,.45)'; X.textAlign = 'center';
                    X.fillText(`ACHIEVEMENTS (${sessionAch.length}/${ACHIEVEMENTS.length})`, cx, nextY + 4);
                    const maxShow = Math.min(sessionAch.length, 8);
                    const achW = Math.min(40, (cW - 28) / maxShow);
                    const achStartX = cx - (maxShow * achW) / 2;
                    sessionAch.slice(0, maxShow).forEach((a, i) => {
                        X.font = '700 24px Outfit'; X.textAlign = 'center';
                        X.fillStyle = a.color; X.shadowBlur = 14; X.shadowColor = a.color;
                        X.fillText(a.icon, achStartX + i * achW + achW / 2, nextY + 30);
                        X.shadowBlur = 0;
                    });
                }

                // Restart ‚Äî bigger, pulsing
                const rY = cY + cH - 36;
                const ra = .45 + Math.sin(goT * 3) * .35;
                X.font = '700 16px Outfit'; X.fillStyle = `rgba(255,255,255,${ra})`;
                X.fillText('TAP TO RESTART', cx, rY);
                addBtn('restart', cX, rY - 22, cW, 44);

                X.restore();
            }


            // ‚îÄ‚îÄ‚îÄ Draw: Shop (v5.0 ULTRA ‚Äî Mockup Match) ‚îÄ‚îÄ
            function drawShop(dt) {
                clearBtns();
                drawNeonGrid(0.15, 0.4);
                drawBg();
                const cx = W / 2;

                // Title ‚Äî MASSIVE with triple glow
                X.font = '900 34px Outfit'; X.textAlign = 'center';
                X.fillStyle = '#fff';
                X.shadowBlur = 40; X.shadowColor = 'rgba(140,123,255,.8)';
                X.fillText('üíé SKIN SHOP', cx, 48);
                X.shadowBlur = 60; X.globalAlpha = .4;
                X.fillText('üíé SKIN SHOP', cx, 48);
                X.shadowBlur = 0; X.globalAlpha = 1;

                // Coin balance pill ‚Äî bigger, gold glow
                const balW = 120, balH = 32, balX = (W - balW) / 2;
                rr(balX, 60, balW, balH, 16);
                X.fillStyle = 'rgba(255,211,106,.15)'; X.fill();
                X.strokeStyle = 'rgba(255,211,106,.5)'; X.lineWidth = 2;
                X.shadowBlur = 12; X.shadowColor = '#ffd36a'; X.stroke(); X.shadowBlur = 0;
                X.font = '800 16px Outfit'; X.fillStyle = '#ffd36a';
                X.fillText('‚óÜ ' + SkinShop.getCoins(), cx, 82);

                shopScroll += (shopTarget - shopScroll) * .12;
                const skins = SkinShop.getSkins();
                const cardH = 105, gap = 14, startY = 108;

                skins.forEach((sk, i) => {
                    const y = startY + i * (cardH + gap) - shopScroll;
                    if (y < 70 || y > H - 90) return;

                    const owned = SkinShop.isUnlocked(sk.id), eq = SkinShop.getEquippedId() === sk.id;

                    // Card background ‚Äî stronger glass
                    const borderColor = eq ? [140, 123, 255] : owned ? [98, 255, 179] : [255, 255, 255];
                    const borderAlpha = eq ? 0.15 : owned ? 0.08 : 0.04;
                    glassPanel(16, y, W - 32, cardH, 20, borderColor, borderAlpha);

                    // THICK neon border with DOUBLE glow (mockup style)
                    rr(16, y, W - 32, cardH, 20);
                    if (eq) {
                        const pa = 0.6 + Math.sin(t * 4) * 0.35;
                        X.strokeStyle = `rgba(140,123,255,${pa})`; X.lineWidth = 3.5;
                        X.shadowBlur = 30; X.shadowColor = '#8c7bff';
                        X.stroke();
                        // Second glow layer
                        X.shadowBlur = 50; X.globalAlpha = 0.3;
                        X.stroke(); X.globalAlpha = 1;
                    } else if (owned) {
                        X.strokeStyle = 'rgba(98,255,179,.45)'; X.lineWidth = 2.5;
                        X.shadowBlur = 20; X.shadowColor = '#62ffb3';
                        X.stroke();
                    } else {
                        X.strokeStyle = 'rgba(255,255,255,.1)'; X.lineWidth = 1.5;
                        X.stroke();
                    }
                    X.shadowBlur = 0;

                    // Swatch ‚Äî TRIPLE layer glow ring (mockup)
                    const swC = sk.rainbow ? rainbowColor(t * 3) : sk.ring;
                    const swX = 56, swY = y + cardH / 2;
                    // Layer 1: Outer diffuse glow
                    X.beginPath(); X.arc(swX, swY, 28, 0, Math.PI * 2);
                    X.fillStyle = swC; X.globalAlpha = .12; X.fill(); X.globalAlpha = 1;
                    // Layer 2: Main ring ‚Äî thick with glow
                    X.beginPath(); X.arc(swX, swY, 20, 0, Math.PI * 2);
                    X.strokeStyle = swC; X.lineWidth = 5;
                    X.shadowBlur = 30; X.shadowColor = swC;
                    X.stroke();
                    // Second pass for stronger glow
                    X.shadowBlur = 50; X.globalAlpha = .35;
                    X.stroke(); X.globalAlpha = 1; X.shadowBlur = 0;
                    // Layer 3: Inner filled dot
                    X.beginPath(); X.arc(swX, swY, 7, 0, Math.PI * 2);
                    X.fillStyle = swC; X.shadowBlur = 10; X.shadowColor = swC;
                    X.fill(); X.shadowBlur = 0;

                    // Name ‚Äî BIGGER, bolder
                    X.font = '800 18px Outfit'; X.textAlign = 'left';
                    X.fillStyle = eq ? '#d4cbff' : '#fff';
                    if (eq) { X.shadowBlur = 8; X.shadowColor = '#8c7bff'; }
                    X.fillText(sk.name, 92, y + 34); X.shadowBlur = 0;
                    // Description
                    X.font = '400 13px Outfit'; X.fillStyle = 'rgba(255,255,255,.5)';
                    X.fillText(sk.desc, 92, y + 54);
                    // Trail tag
                    if (sk.trail) {
                        X.font = '700 10px Outfit'; X.fillStyle = '#ffd36a';
                        X.shadowBlur = 6; X.shadowColor = '#ffd36a';
                        X.fillText('‚ú® TRAIL', 92, y + 72); X.shadowBlur = 0;
                    }

                    // Action button ‚Äî WIDER, BOLDER fills
                    const bW2 = 100, bH2 = 40, bX2 = W - 32 - bW2 - 12, bY2 = y + (cardH - bH2) / 2;
                    if (eq) {
                        // EQUIPPED ‚Äî intense purple fill
                        rr(bX2, bY2, bW2, bH2, 12);
                        X.fillStyle = 'rgba(140,123,255,.3)'; X.fill();
                        X.strokeStyle = 'rgba(140,123,255,.65)'; X.lineWidth = 2;
                        X.shadowBlur = 14; X.shadowColor = '#8c7bff'; X.stroke(); X.shadowBlur = 0;
                        X.font = '800 13px Outfit'; X.textAlign = 'center'; X.fillStyle = '#d4cbff';
                        X.fillText('EQUIPPED', bX2 + bW2 / 2, bY2 + 26);
                    } else if (owned) {
                        // EQUIP ‚Äî intense green fill
                        rr(bX2, bY2, bW2, bH2, 12);
                        X.fillStyle = 'rgba(98,255,179,.2)'; X.fill();
                        X.strokeStyle = 'rgba(98,255,179,.55)'; X.lineWidth = 2;
                        X.shadowBlur = 14; X.shadowColor = '#62ffb3'; X.stroke(); X.shadowBlur = 0;
                        X.font = '800 13px Outfit'; X.textAlign = 'center'; X.fillStyle = '#62ffb3';
                        X.fillText('EQUIP', bX2 + bW2 / 2, bY2 + 26);
                        addBtn('equip_' + sk.id, bX2, bY2, bW2, bH2);
                    } else {
                        // PRICE ‚Äî gold fill with glow
                        const canBuy = SkinShop.getCoins() >= sk.price;
                        rr(bX2, bY2, bW2, bH2, 12);
                        X.fillStyle = canBuy ? 'rgba(255,211,106,.2)' : 'rgba(255,255,255,.04)'; X.fill();
                        X.strokeStyle = canBuy ? 'rgba(255,211,106,.55)' : 'rgba(255,255,255,.1)';
                        X.lineWidth = 2;
                        if (canBuy) { X.shadowBlur = 10; X.shadowColor = '#ffd36a'; }
                        X.stroke(); X.shadowBlur = 0;
                        X.font = '800 14px Outfit'; X.textAlign = 'center';
                        X.fillStyle = canBuy ? '#ffd36a' : 'rgba(255,255,255,.3)';
                        X.fillText('‚óÜ ' + sk.price, bX2 + bW2 / 2, bY2 + 26);
                        if (canBuy) addBtn('buy_' + sk.id, bX2, bY2, bW2, bH2);
                    }
                });

                // BUY COINS ‚Äî gradient glow button
                const bcW = (W - 48 - 12) / 2, bcH = 50;
                rr(20, H - 72, bcW, bcH, 16);
                X.fillStyle = 'rgba(0,255,204,.15)'; X.fill();
                const bcGl = 0.5 + Math.sin(t * 3) * 0.3;
                X.strokeStyle = `rgba(0,255,204,${bcGl})`; X.lineWidth = 2.5;
                X.shadowBlur = 24; X.shadowColor = '#00ffcc'; X.stroke();
                X.shadowBlur = 40; X.globalAlpha = .2; X.stroke();
                X.shadowBlur = 0; X.globalAlpha = 1;
                X.font = '900 15px Outfit'; X.textAlign = 'center'; X.fillStyle = '#00ffcc';
                X.shadowBlur = 8; X.shadowColor = '#00ffcc';
                X.fillText('üí∞ BUY COINS', 20 + bcW / 2, H - 41); X.shadowBlur = 0;
                addBtn('buy_coins', 20, H - 72, bcW, bcH);

                // BACK button ‚Äî brighter
                rr(20 + bcW + 12, H - 72, bcW, bcH, 16);
                X.fillStyle = 'rgba(255,255,255,.07)'; X.fill();
                X.strokeStyle = 'rgba(255,255,255,.18)'; X.lineWidth = 1.5; X.stroke();
                X.font = '700 15px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.75)';
                X.fillText('‚Üê BACK', 20 + bcW + 12 + bcW / 2, H - 41);
                addBtn('back', 20 + bcW + 12, H - 72, bcW, bcH);
            }

            // ‚îÄ‚îÄ‚îÄ Draw: Leaderboard (v5.0 ULTRA ‚Äî Mockup Match) ‚îÄ‚îÄ
            function drawBoard(dt) {
                clearBtns();
                drawNeonGrid(0.15, 0.4);
                drawBg();
                const cx = W / 2;

                // Title ‚Äî MASSIVE with golden triple glow
                X.font = '900 34px Outfit'; X.textAlign = 'center';
                X.fillStyle = '#fff';
                X.shadowBlur = 40; X.shadowColor = 'rgba(255,211,106,.7)';
                X.fillText('üèÜ LEADERBOARD', cx, 48);
                X.shadowBlur = 60; X.globalAlpha = .35;
                X.fillText('üèÜ LEADERBOARD', cx, 48);
                X.shadowBlur = 0; X.globalAlpha = 1;

                const name = Leaderboard.getPlayerName();
                if (name) {
                    // Player name pill ‚Äî bigger, glowing
                    const pnW = 160, pnH = 30, pnX = (W - pnW) / 2;
                    rr(pnX, 60, pnW, pnH, 15);
                    X.fillStyle = 'rgba(140,123,255,.12)'; X.fill();
                    X.strokeStyle = 'rgba(140,123,255,.35)'; X.lineWidth = 1.5;
                    X.shadowBlur = 10; X.shadowColor = '#8c7bff'; X.stroke(); X.shadowBlur = 0;
                    X.font = '700 14px Outfit'; X.fillStyle = '#d4cbff';
                    X.fillText(`Player: ${name}`, cx, 80);
                } else {
                    X.font = '400 14px Outfit'; X.fillStyle = 'rgba(255,255,255,.4)';
                    X.fillText('Set your name to rank!', cx, 72);
                }

                // Name set button ‚Äî bigger, brighter
                if (!name) {
                    const nbW = 150, nbH = 42, nbX = (W - nbW) / 2, nbY = 82;
                    rr(nbX, nbY, nbW, nbH, 14);
                    X.fillStyle = 'rgba(140,123,255,.18)'; X.fill();
                    X.strokeStyle = 'rgba(140,123,255,.5)'; X.lineWidth = 2;
                    X.shadowBlur = 14; X.shadowColor = '#8c7bff'; X.stroke(); X.shadowBlur = 0;
                    X.font = '800 14px Outfit'; X.fillStyle = '#d4cbff'; X.fillText('SET NAME', cx, nbY + 27);
                    addBtn('set_name', nbX, nbY, nbW, nbH);
                }

                // Entries ‚Äî DRAMATICALLY larger cards 
                const startY = name ? 104 : 136;
                const entryH = 66, entryGap = 10;
                const medalBgColors = ['rgba(255,211,106,.15)', 'rgba(200,200,210,.10)', 'rgba(205,127,50,.10)'];
                const medalBorderColors = ['rgba(255,211,106,.6)', 'rgba(200,200,210,.45)', 'rgba(205,127,50,.45)'];
                const medalGlowColors = ['#ffd36a', '#c8c8d2', '#cd7f32'];

                boardData.forEach((e, i) => {
                    const y = startY + i * (entryH + entryGap);
                    if (y > H - 130) return;
                    const isMe = e.name === name;

                    // Card background with thick colored borders
                    rr(16, y, W - 32, entryH, 16);
                    if (isMe) {
                        X.fillStyle = 'rgba(140,123,255,.15)'; X.fill();
                        X.strokeStyle = 'rgba(140,123,255,.6)'; X.lineWidth = 3;
                        X.shadowBlur = 24; X.shadowColor = '#8c7bff'; X.stroke();
                        X.shadowBlur = 40; X.globalAlpha = .25; X.stroke();
                        X.globalAlpha = 1; X.shadowBlur = 0;
                    } else if (i < 3) {
                        X.fillStyle = medalBgColors[i]; X.fill();
                        X.strokeStyle = medalBorderColors[i]; X.lineWidth = 3;
                        X.shadowBlur = 20; X.shadowColor = medalGlowColors[i]; X.stroke();
                        X.shadowBlur = 35; X.globalAlpha = .2; X.stroke();
                        X.globalAlpha = 1; X.shadowBlur = 0;
                    } else {
                        X.fillStyle = 'rgba(255,255,255,.04)'; X.fill();
                        X.strokeStyle = 'rgba(255,255,255,.1)'; X.lineWidth = 1.5; X.stroke();
                    }

                    // Rank ‚Äî large colored circles with glow
                    const rkX = 48, rkY = y + entryH / 2;
                    if (i < 3) {
                        // Medal circle ‚Äî bigger with intense glow
                        X.beginPath(); X.arc(rkX, rkY, 22, 0, Math.PI * 2);
                        X.fillStyle = medalBgColors[i]; X.fill();
                        X.strokeStyle = medalBorderColors[i]; X.lineWidth = 2.5;
                        X.shadowBlur = 18; X.shadowColor = medalGlowColors[i]; X.stroke(); X.shadowBlur = 0;
                        const medals = ['ü•á', 'ü•à', 'ü•â'];
                        X.font = '700 20px Outfit'; X.textAlign = 'center'; X.fillStyle = '#fff';
                        X.fillText(medals[i], rkX, rkY + 7);
                    } else {
                        X.beginPath(); X.arc(rkX, rkY, 18, 0, Math.PI * 2);
                        X.fillStyle = 'rgba(255,255,255,.07)'; X.fill();
                        X.strokeStyle = 'rgba(255,255,255,.12)'; X.lineWidth = 1.5; X.stroke();
                        X.font = '800 16px Outfit'; X.textAlign = 'center';
                        X.fillStyle = 'rgba(255,255,255,.55)';
                        X.fillText('#' + (i + 1), rkX, rkY + 6);
                    }

                    // Name ‚Äî BIGGER, bolder
                    X.font = isMe ? '800 18px Outfit' : '600 17px Outfit'; X.textAlign = 'left';
                    X.fillStyle = isMe ? '#d4cbff' : 'rgba(255,255,255,.9)';
                    if (isMe) { X.shadowBlur = 6; X.shadowColor = '#8c7bff'; }
                    X.fillText(e.name, 82, y + entryH / 2 + 6); X.shadowBlur = 0;

                    // Score ‚Äî MUCH bigger, with intense glow for top
                    X.font = '800 22px Outfit'; X.textAlign = 'right';
                    if (i === 0) {
                        X.fillStyle = '#ffd36a';
                        X.shadowBlur = 20; X.shadowColor = '#ffd36a';
                    } else if (i < 3) {
                        X.fillStyle = medalGlowColors[i];
                        X.shadowBlur = 10; X.shadowColor = medalGlowColors[i];
                    } else if (isMe) {
                        X.fillStyle = '#d4cbff';
                        X.shadowBlur = 8; X.shadowColor = '#8c7bff';
                    } else {
                        X.fillStyle = 'rgba(255,255,255,.8)';
                    }
                    X.fillText(e.score.toLocaleString(), W - 72, y + entryH / 2 + 7);
                    X.shadowBlur = 0;

                    // Delete button (‚úï) ‚Äî bigger
                    const delX = W - 58, delY = y + 6, delS = 30;
                    X.font = '700 16px Outfit'; X.textAlign = 'center';
                    X.fillStyle = 'rgba(255,93,122,.45)'; X.fillText('‚úï', delX + delS / 2, delY + 21);
                    addBtn('del_' + i, delX, delY, delS, delS);
                });

                if (boardData.length === 0) {
                    X.font = '500 16px Outfit'; X.fillStyle = 'rgba(255,255,255,.35)'; X.textAlign = 'center';
                    X.fillText('No scores yet. Play to rank!', cx, H * .45);
                }

                // Clear All ‚Äî bigger, more prominent
                if (boardData.length > 0) {
                    const clW = 120, clH = 38, clX = W - clW - 20, clY = H - 124;
                    rr(clX, clY, clW, clH, 12);
                    X.fillStyle = 'rgba(255,93,122,.12)'; X.fill();
                    X.strokeStyle = 'rgba(255,93,122,.4)'; X.lineWidth = 2;
                    X.shadowBlur = 10; X.shadowColor = '#ff5d7a'; X.stroke(); X.shadowBlur = 0;
                    X.font = '800 12px Outfit'; X.textAlign = 'center'; X.fillStyle = '#ff5d7a';
                    X.fillText('üóë CLEAR ALL', clX + clW / 2, clY + 24);
                    addBtn('clear_board', clX, clY, clW, clH);
                }

                // Back button ‚Äî bigger, brighter
                rr(16, H - 72, W - 32, 50, 16);
                X.fillStyle = 'rgba(255,255,255,.07)'; X.fill();
                X.strokeStyle = 'rgba(255,255,255,.18)'; X.lineWidth = 1.5; X.stroke();
                X.font = '700 16px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.75)';
                X.fillText('‚Üê BACK', cx, H - 41);
                addBtn('back', 16, H - 72, W - 32, 50);
            }

            // ‚îÄ‚îÄ‚îÄ Draw: Name Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function drawNameInput(dt) {
                clearBtns();
                X.fillStyle = 'rgba(7,8,12,.85)'; X.fillRect(0, 0, W, H);
                const cx = W / 2, cy = H * .4;
                const cW2 = W * .8, cH2 = 180, cX2 = (W - cW2) / 2;
                rr(cX2, cy - 40, cW2, cH2, 20); X.fillStyle = 'rgba(255,255,255,.06)'; X.fill(); X.strokeStyle = 'rgba(255,255,255,.1)'; X.lineWidth = 1; X.stroke();

                X.font = '600 16px Outfit'; X.textAlign = 'center'; X.fillStyle = 'rgba(255,255,255,.9)'; X.fillText('Enter Your Name', cx, cy);

                // Input field
                const iW = cW2 - 48, iH = 36, iX = cX2 + 24, iY = cy + 16;
                rr(iX, iY, iW, iH, 10); X.fillStyle = 'rgba(255,255,255,.08)'; X.fill(); X.strokeStyle = 'rgba(140,123,255,.4)'; X.lineWidth = 1; X.stroke();

                nameCursor += dt;
                const cursor = Math.sin(nameCursor * 4) > .2 ? '|' : '';
                X.font = '500 15px Outfit'; X.textAlign = 'center'; X.fillStyle = nameInput ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.3)';
                X.fillText(nameInput ? (nameInput + cursor) : 'Type name...' + cursor, cx, iY + 24);

                // Confirm
                const cbW = 100, cbH = 36, cbX = (W - cbW) / 2, cbY = cy + 70;
                rr(cbX, cbY, cbW, cbH, 10); X.fillStyle = nameInput.length > 0 ? 'rgba(98,255,179,.12)' : 'rgba(255,255,255,.03)'; X.fill();
                X.strokeStyle = nameInput.length > 0 ? 'rgba(98,255,179,.3)' : 'rgba(255,255,255,.06)'; X.lineWidth = 1; X.stroke();
                X.font = '600 13px Outfit'; X.textAlign = 'center'; X.fillStyle = nameInput.length > 0 ? '#62ffb3' : 'rgba(255,255,255,.25)'; X.fillText('CONFIRM', cx, cbY + 23);
                if (nameInput.length > 0) addBtn('confirm_name', cbX, cbY, cbW, cbH);

                addBtn('back', 0, 0, 50, 50);
            }

            // ‚îÄ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function handleTap(px, py) {
                Audio.init();
                const btn = hitBtn(px, py);

                if (state === S.NAME) {
                    if (btn?.id === 'confirm_name' && nameInput.length > 0) {
                        Leaderboard.setPlayerName(nameInput); nameInput = ''; Audio.buy(); state = S.BOARD;
                        Leaderboard.getTopScores(10).then(d => { boardData = d });
                    }
                    return;
                }

                if (state === S.MENU) {
                    if (btn?.id === 'shop') { Audio.ui(); state = S.SHOP; shopScroll = 0; shopTarget = 0; return }
                    if (btn?.id === 'board') { Audio.ui(); state = S.BOARD; Leaderboard.getTopScores(10).then(d => { boardData = d }); return }
                    // Go to difficulty selection
                    Audio.ui(); state = S.DIFF; return;
                }

                if (state === S.DIFF) {
                    if (btn?.id === 'back') { Audio.ui(); state = S.MENU; return }
                    if (btn?.id?.startsWith('diff_')) { difficulty = parseInt(btn.id.slice(5)); Audio.ui(); return }
                    if (btn?.id === 'start_game') {
                        const dc = DIFF_CFG[difficulty];
                        state = S.PLAY; score = 0; combo = 0; maxCombo = 0; level = 1;
                        lives = dc.lives; t = 0; bpm = dc.bpmBase; fbT = 0;
                        feverMode = false; feverT = 0; rollScore = 0;
                        accP = 0; accG = 0; accO = 0; accM = 0;
                        particles = []; ripples = []; initBg(); return;
                    }
                    return;
                }

                if (state === S.SHOP) {
                    if (btn?.id === 'back') { Audio.ui(); state = S.MENU; return }
                    if (btn?.id === 'buy_coins') { Audio.ui(); openCoinShop(); return }
                    if (btn?.id.startsWith('buy_')) { const id = btn.id.slice(4); const r = SkinShop.buySkin(id); if (r.ok) { Audio.buy(); SkinShop.equipSkin(id) } return }
                    if (btn?.id.startsWith('equip_')) { const id = btn.id.slice(6); SkinShop.equipSkin(id); Audio.ui(); return }
                    return;
                }

                if (state === S.BOARD) {
                    if (btn?.id === 'back') { Audio.ui(); state = S.MENU; return }
                    if (btn?.id === 'set_name') { Audio.ui(); state = S.NAME; nameInput = ''; nameInputActive = true; const mi = document.getElementById('mobileNameInput'); if (mi) { mi.value = ''; setTimeout(() => mi.focus(), 100); } return }
                    if (btn?.id?.startsWith('del_')) {
                        const idx = parseInt(btn.id.slice(4));
                        Leaderboard.deleteByIndex(idx);
                        Leaderboard.getTopScores(10).then(d => { boardData = d });
                        Audio.ui(); return;
                    }
                    if (btn?.id === 'clear_board') {
                        if (confirm('üóë Îû≠ÌÇπ Í∏∞Î°ùÏùÑ Ï†ÑÎ∂Ä ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nClear all ranking records?')) {
                            Leaderboard.clearAll(); boardData = []; Audio.ui();
                        }
                        return;
                    }
                    return;
                }

                if (state === S.OVER) {
                    if (btn?.id === 'restart' && goT > .8) { state = S.MENU; goT = 0; menuT = 0; return }
                    return;
                }

                // ‚îÄ‚îÄ Playing tap ‚îÄ‚îÄ
                const sm = scoreMult();
                const n = pv(t), th2 = thr(), cx = W / 2, cy = H * .44;
                if (n < th2.p) {
                    const pts = Math.round((15 + combo * 2) * sm);
                    score += pts; combo++; maxCombo = Math.max(maxCombo, combo); accP++;
                    fb = 'PERFECT!'; fbC = '#7fe0ff'; fbT = 1.2; spT = `+${pts}`; spTm = .8; cShk = 1;
                    Audio.perfect(); burst(cx, cy, '#7fe0ff', 25); ripple(cx, cy, '#7fe0ff'); ripple(cx, cy, '#7fe0ff');
                    screenFlashT = 1; screenFlashC = '#7fe0ff';
                } else if (n < th2.g) {
                    const pts = Math.round((10 + combo) * sm);
                    score += pts; combo++; maxCombo = Math.max(maxCombo, combo); accG++;
                    fb = 'GOOD!'; fbC = '#62ffb3'; fbT = 1; spT = `+${pts}`; spTm = .8;
                    Audio.good(); burst(cx, cy, '#62ffb3', 15); ripple(cx, cy, '#62ffb3')
                } else if (n < th2.o) {
                    const pts = Math.round(3 * sm);
                    score += pts; combo = 0; accO++;
                    fb = 'OK'; fbC = '#ffd36a'; fbT = .8; spT = `+${pts}`; spTm = .6;
                    Audio.ok(); burst(cx, cy, '#ffd36a', 8)
                } else {
                    combo = 0; lives--; accM++;
                    fb = 'MISS'; fbC = '#ff5d7a'; fbT = .8; spT = ''; Audio.miss(); cShk = 2;
                    vignetteT = 1;
                    if (lives <= 0) {
                        feverMode = false;
                        checkAchievements(true); // v4.0 final achievement check
                        state = S.OVER; goT = 0; earnedCoins = SkinShop.calcEarnedCoins(score, maxCombo, level); SkinShop.addCoins(earnedCoins); Audio.coin();
                        if (score > hi) { hi = score; localStorage.setItem('arkPD_hi', hi.toString()) }
                        if (Leaderboard.hasName()) Leaderboard.submitScore(score, level, maxCombo); Audio.gameOver(); return
                    }
                }

                // Level up ‚Üí Wave announcement
                const needed = 80 + (level - 1) * 40;
                if (score >= needed * level) {
                    level++; bpm = DIFF_CFG[difficulty].bpmBase + (level - 1) * 6;
                    Audio.levelUp(); fb = 'LEVEL ' + level;
                    const sk = SkinShop.getCurrentSkin(); fbC = sk.ring; fbT = 2;
                    burst(cx, cy, fbC, 30);
                    triggerWave(level); // v4.0 wave announcement
                }
                checkAchievements(); // v4.0 achievement check
            }

            C.addEventListener('click', e => { const r = C.getBoundingClientRect(); handleTap(e.clientX - r.left, e.clientY - r.top) });
            C.addEventListener('touchstart', e => { e.preventDefault(); const tc = e.touches[0], r = C.getBoundingClientRect(); handleTap(tc.clientX - r.left, tc.clientY - r.top) }, { passive: false });

            // Keyboard for name input (desktop)
            addEventListener('keydown', e => {
                if (state !== S.NAME) return;
                if (e.key === 'Backspace') { nameInput = nameInput.slice(0, -1); const mi = document.getElementById('mobileNameInput'); if (mi) mi.value = nameInput; return }
                if (e.key === 'Enter' && nameInput.length > 0) { Leaderboard.setPlayerName(nameInput); nameInput = ''; Audio.buy(); state = S.BOARD; Leaderboard.getTopScores(10).then(d => { boardData = d }); const mi = document.getElementById('mobileNameInput'); if (mi) { mi.value = ''; mi.blur(); } return }
                if (e.key.length === 1 && nameInput.length < 12) { nameInput += e.key; const mi = document.getElementById('mobileNameInput'); if (mi) mi.value = nameInput; }
            });

            // Mobile name input sync (virtual keyboard)
            const mobileInput = document.getElementById('mobileNameInput');
            if (mobileInput) {
                mobileInput.addEventListener('input', e => {
                    if (state !== S.NAME) return;
                    nameInput = (e.target.value || '').slice(0, 12);
                });
                mobileInput.addEventListener('keydown', e => {
                    if (state !== S.NAME) return;
                    if (e.key === 'Enter' && nameInput.length > 0) {
                        e.preventDefault();
                        Leaderboard.setPlayerName(nameInput); nameInput = ''; Audio.buy(); state = S.BOARD;
                        Leaderboard.getTopScores(10).then(d => { boardData = d });
                        mobileInput.value = ''; mobileInput.blur();
                    }
                });
            }

            // Shop scroll
            C.addEventListener('wheel', e => { if (state === S.SHOP) { shopTarget = Math.max(0, shopTarget + e.deltaY * .5) } }, { passive: true });

            // ‚îÄ‚îÄ‚îÄ Coin Shop (PayPal Modal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function openCoinShop() {
                const modal = document.getElementById('coinShopModal');
                const container = document.getElementById('coinPacksContainer');
                const balanceEl = document.getElementById('coinShopBalance');
                if (!modal || !container) return;

                // Update balance display
                if (balanceEl && window.SkinShop) {
                    balanceEl.textContent = `Your Balance: ‚óÜ ${SkinShop.getCoins()}`;
                }

                container.innerHTML = '';
                const packs = PayPalShop.getPacks();
                const tierMap = ['starter', 'plus', 'pro', 'ultra'];
                const coinEmojis = ['ü™ô', 'üí∞', 'üíé', 'üëë'];

                packs.forEach((pack, i) => {
                    const card = document.createElement('div');
                    card.className = `coin-pack-card tier-${tierMap[i]}`;

                    // Badges
                    let badge = '';
                    if (i === 2) badge = '<span class="badge-popular">POPULAR</span>';
                    if (i === 3) badge = '<span class="badge-bestvalue">‚≠ê BEST VALUE</span>';

                    // Bonus badge
                    let bonusBadge = '';
                    if (pack.bonus && pack.bonus !== 'BEST VALUE') {
                        const badgeColor = i <= 1 ? 'cyan' : 'gold';
                        bonusBadge = `<span class="badge-bonus ${badgeColor}">${pack.bonus}</span>`;
                    }

                    card.innerHTML = `${badge}
                        <div class="coin-pack-header">
                            <div>
                                <span class="coin-pack-label">${coinEmojis[i]} ${pack.label}</span>${bonusBadge}
                            </div>
                            <span class="coin-pack-price">$${pack.price}</span>
                        </div>
                        <div id="pp-btn-${pack.id}" style="min-height:45px;"></div>
                    `;
                    container.appendChild(card);
                });

                modal.style.display = 'block';

                // Load SDK and render buttons
                PayPalShop.loadSDK().then(() => {
                    packs.forEach(pack => {
                        PayPalShop.renderButtons(`pp-btn-${pack.id}`, pack.id,
                            (p, details) => {
                                console.log(`[CoinShop] ‚úÖ Purchased ${p.coins} coins! Order: ${details.id}`);
                                closeCoinShop();
                                fb = `+${p.coins} COINS!`; fbC = '#ffd36a'; fbT = 2.5;
                                // Update balance
                                if (balanceEl) balanceEl.textContent = `Your Balance: ‚óÜ ${SkinShop.getCoins()}`;
                            },
                            (err) => {
                                console.error('[CoinShop] Payment failed:', err);
                            }
                        );
                    });
                }).catch(err => {
                    console.error('[CoinShop] SDK load failed:', err);
                    container.innerHTML = '<p style="text-align:center;color:#ff5d7a;font-family:Outfit,sans-serif;padding:20px;">Failed to load payment system. Please try again.</p>';
                });
            }

            function closeCoinShop() {
                const modal = document.getElementById('coinShopModal');
                if (modal) modal.style.display = 'none';
            }

            document.getElementById('coinShopClose')?.addEventListener('click', closeCoinShop);

            // ‚îÄ‚îÄ‚îÄ Loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let last = performance.now();
            function loop(now) {
                const dt = Math.min((now - last) / 1000, .05); last = now; resize(); X.clearRect(0, 0, W, H);
                switch (state) {
                    case S.MENU: drawMenu(dt); break;
                    case S.DIFF: drawDifficulty(dt); break;
                    case S.PLAY: t += dt * spd(); drawGame(dt); break;
                    case S.OVER: drawGame(dt); drawGameOver(dt); break;
                    case S.SHOP: drawShop(dt); break;
                    case S.BOARD: drawBoard(dt); break;
                    case S.NAME: drawNameInput(dt); break;
                }
                requestAnimationFrame(loop);
            }
            initBg(); requestAnimationFrame(loop);
        })();
    </script>
</body>

</html>